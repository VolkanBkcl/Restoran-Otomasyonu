<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ödeme Ekranı</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
    <style>
        body { background: #0f172a; color: #e2e8f0; min-height: 100vh; }
        .card { background: #111827; border: 1px solid #1f2937; }
        .badge-status { font-size: 0.9rem; }
        .status-disconnected { color: #ef4444; }
        .status-connected { color: #22c55e; }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 id="title">Ödeme Ekranı</h2>
            <p class="text-secondary mb-0" id="orderInfo">Sipariş yükleniyor...</p>
        </div>
        <a href="/masa/" class="btn btn-outline-light">← Geri</a>
    </div>

    <div class="row g-3">
        <div class="col-lg-7">
            <div class="card p-3 mb-3">
                <h5 class="mb-3">Sipariş Özeti</h5>
                <div id="orderSummary" class="text-secondary">Yükleniyor...</div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card p-3 mb-3">
                <h5 class="mb-3">Ödeme</h5>
                <div class="d-flex justify-content-between">
                    <span>Toplam Tutar</span>
                    <strong id="totalTl">- ₺</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Kripto Karşılığı</span>
                    <strong id="totalEth">- ETH</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Cüzdan Durumu</span>
                    <span id="walletStatus" class="badge-status status-disconnected">MetaMask bağlı değil</span>
                </div>
                <div class="mt-3 d-grid gap-2">
                    <button id="btnConnect" class="btn btn-outline-warning">MetaMask Bağla</button>
                    <button id="btnPay" class="btn btn-success" disabled>Ödemeyi Tamamla (Blockchain)</button>
                    <button id="btnCash" class="btn btn-secondary">Nakit / Kasada Öde</button>
                </div>
                <div id="txResult" class="mt-3 small text-secondary"></div>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE_URL = window.location.origin;
const CONTRACT_ADDRESS = "0xYOUR_CONTRACT_ADDRESS";
const CONTRACT_ABI = [
    "function payOrder(uint256 masaId, string siparisHash) payable"
];

let provider, signer, connectedAccount;
let orderId = null;
let orderDetail = null;
let ethAmount = "0.001";

document.addEventListener("DOMContentLoaded", async () => {
    const params = new URLSearchParams(window.location.search);
    orderId = params.get("orderId");
    if (!orderId) {
        alert("OrderId bulunamadı");
        return;
    }
    await loadOrder();
    wireUi();
});

function wireUi() {
    document.getElementById("btnConnect").onclick = connectWallet;
    document.getElementById("btnPay").onclick = payWithBlockchain;
    document.getElementById("btnCash").onclick = payCash;
}

async function loadOrder() {
    try {
        const res = await fetch(`${API_BASE_URL}/api/order/detail/${orderId}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.message || "Sipariş alınamadı");

        orderDetail = data.data;
        document.getElementById("title").innerText = `Ödeme Ekranı - Masa ${orderDetail.masaId}`;
        document.getElementById("orderInfo").innerText = `Sipariş #${orderDetail.satisKodu} • ${new Date(orderDetail.tarih).toLocaleString('tr-TR')}`;

        const netTl = Number(orderDetail.netTutar || orderDetail.tutar || 0);
        document.getElementById("totalTl").innerText = `${netTl.toFixed(2)} ₺`;

        // Basit sabit kur: 1 ETH = 55.000 ₺ (test amaçlı)
        const ethFromRate = netTl / 55000;
        ethAmount = (ethFromRate || 0.001).toFixed(6);
        document.getElementById("totalEth").innerText = `${ethAmount} ETH`;

        document.getElementById("orderSummary").innerHTML = `
            <div>Masa: <strong>${orderDetail.masaAdi || orderDetail.masaId}</strong></div>
            <div>Tutar: <strong>${netTl.toFixed(2)} ₺</strong></div>
            <div>Durum: <strong>${getOdemeText(orderDetail.odemeDurumu)}</strong></div>
        `;
    } catch (err) {
        console.error(err);
        alert("Sipariş yüklenirken hata: " + err.message);
    }
}

function getOdemeText(v) {
    switch (v) {
        case 0: return "Ödeme Bekliyor";
        case 1: return "Kendi Ödedi";
        case 2: return "Tamamı Ödendi";
        default: return "Bilinmiyor";
    }
}

async function connectWallet() {
    if (!window.ethereum) {
        alert("Lütfen MetaMask kurun");
        return;
    }
    try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        connectedAccount = await signer.getAddress();
        document.getElementById("walletStatus").innerText = `Bağlandı: ${connectedAccount.slice(0,6)}...${connectedAccount.slice(-4)}`;
        document.getElementById("walletStatus").classList.remove("status-disconnected");
        document.getElementById("walletStatus").classList.add("status-connected");
        document.getElementById("btnPay").disabled = false;
        document.getElementById("btnConnect").style.display = "none";
    } catch (err) {
        console.error(err);
        alert("Cüzdan bağlanamadı: " + err.message);
    }
}

async function payWithBlockchain() {
    if (!signer || !orderDetail) {
        alert("Önce cüzdan bağlayın");
        return;
    }
    try {
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        const tx = await contract.payOrder(orderDetail.masaId, orderDetail.satisKodu, {
            value: ethers.parseEther(ethAmount)
        });
        document.getElementById("txResult").innerText = "İşlem gönderildi: " + tx.hash;
        const receipt = await tx.wait();
        document.getElementById("txResult").innerText = "Onaylandı: " + receipt.hash;

        await finalizePayment(receipt.hash, "Blockchain");
        alert("Ödeme başarılı! Siparişlerim sayfasına yönlendiriliyorsunuz.");
        window.location.href = "/masa/";
    } catch (err) {
        console.error(err);
        alert("Ödeme başarısız: " + err.message);
    }
}

async function payCash() {
    try {
        await finalizePayment(null, "Nakit");
        alert("Ödeme kaydedildi (Nakit). Siparişlerim sayfasına yönlendiriliyorsunuz.");
        window.location.href = "/masa/";
    } catch (err) {
        console.error(err);
        alert("Nakit ödeme kaydedilemedi: " + err.message);
    }
}

async function finalizePayment(txHash, odemeTuru) {
    const body = {
        siparisId: orderDetail.id,
        satisKodu: orderDetail.satisKodu,
        txHash: txHash,
        odemeTuru: odemeTuru,
        odenenTutar: orderDetail.netTutar
    };

    const res = await fetch(`${API_BASE_URL}/api/order/finalizePayment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!data.success) {
        throw new Error(data.message || "FinalizePayment başarısız");
    }
}
</script>
</body>
</html>

