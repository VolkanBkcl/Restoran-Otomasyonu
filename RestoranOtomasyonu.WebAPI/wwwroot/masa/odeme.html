<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√ñdeme Ekranƒ± - Blockchain √ñdeme</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .payment-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        .payment-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .payment-header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
        }
        .payment-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        .payment-content {
            padding: 40px;
        }
        .order-summary-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }
        .order-summary-card h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.3rem;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-item strong {
            color: #667eea;
        }
        .total-amount {
            font-size: 2rem;
            font-weight: bold;
            color: #28a745;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            text-align: center;
        }
        .crypto-equivalent {
            font-size: 1.3rem;
            color: #667eea;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
        }
        .wallet-status {
            padding: 15px;
            border-radius: 10px;
            margin: 25px 0;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .wallet-status.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }
        .wallet-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }
        .btn {
            width: 100%;
            padding: 15px 25px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .tx-result {
            margin-top: 20px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 10px;
            border-left: 4px solid #2196F3;
            display: none;
        }
        .tx-result.show {
            display: block;
        }
        .tx-result.success {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .tx-result.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: white;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            transition: all 0.3s;
        }
        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="payment-header">
            <a href="javascript:history.back()" class="back-link">‚Üê Geri D√∂n</a>
            <h1>üí≥ √ñdeme Ekranƒ±</h1>
            <p id="orderInfo">Sipari≈ü y√ºkleniyor...</p>
        </div>

        <div class="payment-content">
            <!-- Sipari≈ü √ñzeti -->
            <div class="order-summary-card">
                <h3>üìã Sipari≈ü √ñzeti</h3>
                <div id="orderSummary">
                    <div class="summary-item">
                        <span>Sipari≈ü Kodu:</span>
                        <strong id="satisKodu">-</strong>
                    </div>
                    <div class="summary-item">
                        <span>Masa:</span>
                        <strong id="masaInfo">-</strong>
                    </div>
                    <div class="summary-item">
                        <span>Durum:</span>
                        <strong id="odemeDurumu">-</strong>
                    </div>
                    <div class="summary-item">
                        <span>Tarih:</span>
                        <strong id="siparisTarihi">-</strong>
                    </div>
                </div>
                <div class="total-amount">
                    Toplam: <span id="totalTl">0.00</span> ‚Ç∫
                </div>
                <div class="crypto-equivalent">
                    üíé Kripto Kar≈üƒ±lƒ±ƒüƒ±: <span id="totalEth">0.0000</span> ETH
                </div>
            </div>

            <!-- C√ºzdan Durumu -->
            <div id="walletStatus" class="wallet-status disconnected">
                ‚ö†Ô∏è MetaMask Baƒülƒ± Deƒüil
            </div>

            <!-- √ñdeme Butonlarƒ± -->
            <div class="btn-group">
                <button id="btnConnect" class="btn btn-primary">
                    üîó MetaMask Baƒüla
                </button>
                <button id="btnPay" class="btn btn-success" disabled>
                    ‚úÖ √ñdemeyi Tamamla (Blockchain)
                </button>
                <button id="btnCash" class="btn btn-secondary">
                    üíµ Nakit / Kasada √ñde
                </button>
            </div>

            <!-- Transaction Sonucu -->
            <div id="txResult" class="tx-result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        const CONTRACT_ADDRESS = "0xC04b9C087d1C67Eb1edC1e48Af1Af0AbaaBB2318"; // Ganache'tan deploy ettikten sonra buraya yapƒ±≈ütƒ±r
        const CONTRACT_ABI = [
            {
                "inputs": [],
                "name": "hasilatiCek",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "odeyen",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "miktar",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "siparisId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "zaman",
                        "type": "uint256"
                    }
                ],
                "name": "OdemeAlindi",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "siparisId",
                        "type": "uint256"
                    }
                ],
                "name": "payBill",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "kasaBakiyesi",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "kasaSahibi",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];
        const GANACHE_CHAIN_ID = 1337; // Ganache varsayƒ±lan Chain ID (veya 5777)
        const ETH_TO_TL_RATE = 100000; // 1 ETH = 100.000 TL (test i√ßin sabit kur)

        let provider, signer, connectedAccount;
        let orderId = null;
        let orderDetail = null;
        let ethAmount = "0.001";

        document.addEventListener("DOMContentLoaded", async () => {
            const params = new URLSearchParams(window.location.search);
            orderId = params.get("orderId");
            const masaId = params.get("masaId");
            
            if (!orderId) {
                alert("Sipari≈ü ID bulunamadƒ±! L√ºtfen tekrar deneyin.");
                window.location.href = `${API_BASE_URL}/masa/${masaId || ''}`;
                return;
            }
            
            await loadOrder();
            wireUi();
        });

        function wireUi() {
            document.getElementById("btnConnect").onclick = connectWallet;
            document.getElementById("btnPay").onclick = payWithBlockchain;
            document.getElementById("btnCash").onclick = payCash;
        }

        async function loadOrder() {
            try {
                console.log('Sipari≈ü y√ºkleniyor, OrderId:', orderId);
                const res = await fetch(`${API_BASE_URL}/api/order/detail/${orderId}`);
                const data = await res.json();
                
                if (!data.success) {
                    throw new Error(data.message || "Sipari≈ü alƒ±namadƒ±");
                }

                orderDetail = data.data;
                console.log('Sipari≈ü detayƒ±:', orderDetail);

                // Ba≈ülƒ±k ve bilgileri g√ºncelle
                document.getElementById("orderInfo").innerText = `Sipari≈ü #${orderDetail.satisKodu} ‚Ä¢ Masa ${orderDetail.masaId}`;
                document.getElementById("satisKodu").textContent = orderDetail.satisKodu || '-';
                document.getElementById("masaInfo").textContent = orderDetail.masaAdi || `Masa ${orderDetail.masaId}`;
                document.getElementById("odemeDurumu").textContent = getOdemeText(orderDetail.odemeDurumu);
                document.getElementById("siparisTarihi").textContent = new Date(orderDetail.tarih).toLocaleString('tr-TR');

                const netTl = Number(orderDetail.netTutar || orderDetail.tutar || 0);
                document.getElementById("totalTl").textContent = netTl.toFixed(2);

                // ETH kar≈üƒ±lƒ±ƒüƒ±nƒ± hesapla
                const ethFromRate = netTl / ETH_TO_TL_RATE;
                ethAmount = (ethFromRate || 0.001).toFixed(6);
                document.getElementById("totalEth").textContent = ethAmount;

                // Eƒüer zaten √∂dendiyse butonlarƒ± devre dƒ±≈üƒ± bƒ±rak
                if (orderDetail.odemeDurumu === 1 || orderDetail.odemeDurumu === 2) {
                    document.getElementById("btnPay").disabled = true;
                    document.getElementById("btnCash").disabled = true;
                    document.getElementById("btnPay").textContent = "‚úÖ Bu sipari≈ü zaten √∂dendi";
                    document.getElementById("btnCash").textContent = "‚úÖ Bu sipari≈ü zaten √∂dendi";
                }

            } catch (err) {
                console.error("Sipari≈ü y√ºkleme hatasƒ±:", err);
                alert("Sipari≈ü y√ºklenirken hata: " + err.message);
                window.location.href = `${API_BASE_URL}/masa/${orderDetail?.masaId || ''}`;
            }
        }

        function getOdemeText(v) {
            switch (v) {
                case 0: return "√ñdeme Bekliyor";
                case 1: return "Kendi √ñdedi";
                case 2: return "Tamamƒ± √ñdendi";
                case 3: return "√ñdeme Bekliyor";
                default: return "Bilinmiyor";
            }
        }

        async function connectWallet() {
            if (!window.ethereum) {
                alert("MetaMask bulunamadƒ±! L√ºtfen MetaMask eklentisini y√ºkleyin.");
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                document.getElementById("btnConnect").innerHTML = '<span class="loading-spinner"></span>Baƒülanƒ±yor...';
                document.getElementById("btnConnect").disabled = true;

                // C√ºzdan baƒülama izni iste
                const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
                
                if (!accounts || accounts.length === 0) {
                    throw new Error("C√ºzdan baƒülantƒ±sƒ± reddedildi");
                }

                // Provider ve Signer olu≈ütur
                provider = new ethers.BrowserProvider(window.ethereum);
                provider.pollingInterval = 15000; // RPC limitini a≈ümamak i√ßin sorgu s√ºresini uzat (15sn)
                signer = await provider.getSigner();
                connectedAccount = await signer.getAddress();

                console.log('‚úÖ C√ºzdan baƒülandƒ±:', connectedAccount);

                // Aƒü kontrol√º
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const chainIdDecimal = parseInt(chainId, 16);
                
                if (chainIdDecimal !== GANACHE_CHAIN_ID && chainIdDecimal !== 5777) {
                    const switchResult = confirm(`Yanlƒ±≈ü aƒü tespit edildi!\n\n≈ûu anki Chain ID: ${chainIdDecimal}\nGanache Chain ID: ${GANACHE_CHAIN_ID}\n\nGanache aƒüƒ±na ge√ßmek ister misiniz?`);
                    
                    if (switchResult) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: `0x${GANACHE_CHAIN_ID.toString(16)}` }]
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: `0x${GANACHE_CHAIN_ID.toString(16)}`,
                                        chainName: 'Ganache Local',
                                        nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                        rpcUrls: ['http://127.0.0.1:7545']
                                    }]
                                });
                            }
                        }
                    } else {
                        document.getElementById("btnConnect").innerHTML = 'üîó MetaMask Baƒüla';
                        document.getElementById("btnConnect").disabled = false;
                        return;
                    }
                }

                // C√ºzdan durumunu g√ºncelle
                document.getElementById("walletStatus").innerHTML = `‚úÖ Baƒülandƒ±: ${connectedAccount.slice(0,6)}...${connectedAccount.slice(-4)}`;
                document.getElementById("walletStatus").classList.remove("disconnected");
                document.getElementById("walletStatus").classList.add("connected");
                
                document.getElementById("btnPay").disabled = false;
                document.getElementById("btnConnect").style.display = "none";

            } catch (err) {
                console.error("C√ºzdan baƒülama hatasƒ±:", err);
                alert("C√ºzdan baƒülanamadƒ±: " + err.message);
                document.getElementById("btnConnect").innerHTML = 'üîó MetaMask Baƒüla';
                document.getElementById("btnConnect").disabled = false;
            }
        }

        async function payWithBlockchain() {
            if (!signer || !orderDetail) {
                alert("√ñnce MetaMask c√ºzdanƒ±nƒ±zƒ± baƒülayƒ±n!");
                return;
            }

            if (CONTRACT_ADDRESS === "0xYOUR_CONTRACT_ADDRESS" || !CONTRACT_ADDRESS || CONTRACT_ADDRESS.length < 10) {
                alert("Kontrat adresi ayarlanmamƒ±≈ü!\n\nL√ºtfen app.js dosyasƒ±nda CONTRACT_ADDRESS deƒüi≈ükenini Ganache'tan deploy ettiƒüiniz kontrat adresi ile g√ºncelleyin.");
                return;
            }

            if (!confirm(`Blockchain √ºzerinden √∂deme yapmak istediƒüinize emin misiniz?\n\nTutar: ${orderDetail.netTutar.toFixed(2)} ‚Ç∫\nETH: ${ethAmount} ETH\n\nMetaMask'ta i≈ülemi onaylayƒ±n.`)) {
                return;
            }

            try {
                document.getElementById("btnPay").innerHTML = '<span class="loading-spinner"></span>ƒ∞≈ülem g√∂nderiliyor...';
                document.getElementById("btnPay").disabled = true;

                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                console.log('payBill √ßaƒürƒ±lƒ±yor:', {
                    orderId: parseInt(orderId),
                    ethAmount: ethAmount,
                    ethAmountWei: ethers.parseEther(ethAmount).toString()
                });

                const tx = await contract.payBill(parseInt(orderId), {
                    value: ethers.parseEther(ethAmount),
                    gasLimit: 300000
                });

                console.log('Transaction g√∂nderildi:', tx.hash);
                showTxResult(`ƒ∞≈ülem g√∂nderildi: ${tx.hash}`, 'info');
                document.getElementById("btnPay").innerHTML = '<span class="loading-spinner"></span>Onaylanƒ±yor...';

                const receipt = await tx.wait();
                console.log('Transaction onaylandƒ±:', receipt);

                if (receipt.status === 1) {
                    // Backend'e √∂deme tamamlama isteƒüi g√∂nder
                    await completePaymentOnBackend(receipt.hash);
                    
                    showTxResult(`‚úÖ √ñdeme Blockchain √úzerinde Onaylandƒ±!\n\nTransaction Hash: ${receipt.hash}`, 'success');
                    document.getElementById("btnPay").innerHTML = '‚úÖ √ñdeme Tamamlandƒ±';
                    
                    setTimeout(() => {
                        alert("√ñdeme ba≈üarƒ±lƒ±! Sipari≈ülerim sayfasƒ±na y√∂nlendiriliyorsunuz.");
                        const masaId = new URLSearchParams(window.location.search).get("masaId");
                        window.location.href = `${API_BASE_URL}/masa/${masaId || orderDetail.masaId}`;
                    }, 2000);
                } else {
                    throw new Error("Transaction ba≈üarƒ±sƒ±z oldu");
                }

            } catch (err) {
                console.error("Blockchain √∂deme hatasƒ±:", err);
                
                let errorMessage = "√ñdeme ba≈üarƒ±sƒ±z!";
                if (err.code === 4001) {
                    errorMessage = "ƒ∞≈ülem kullanƒ±cƒ± tarafƒ±ndan reddedildi.";
                } else if (err.message?.includes('insufficient funds')) {
                    errorMessage = "Yetersiz ETH bakiyesi! Ganache'tan test ETH alƒ±n.";
                } else if (err.message) {
                    errorMessage = err.message;
                }
                
                showTxResult(`‚ùå Hata: ${errorMessage}`, 'error');
                document.getElementById("btnPay").innerHTML = '‚úÖ √ñdemeyi Tamamla (Blockchain)';
                document.getElementById("btnPay").disabled = false;
            }
        }

        async function payCash() {
            if (!confirm(`Nakit √∂deme yapmak istediƒüinize emin misiniz?\n\nTutar: ${orderDetail.netTutar.toFixed(2)} ‚Ç∫`)) {
                return;
            }

            try {
                document.getElementById("btnCash").innerHTML = '<span class="loading-spinner"></span>Kaydediliyor...';
                document.getElementById("btnCash").disabled = true;

                await completePaymentOnBackend(null, "Nakit");
                
                showTxResult("‚úÖ Nakit √∂deme kaydedildi!", 'success');
                
                setTimeout(() => {
                    alert("√ñdeme kaydedildi (Nakit). Sipari≈ülerim sayfasƒ±na y√∂nlendiriliyorsunuz.");
                    const masaId = new URLSearchParams(window.location.search).get("masaId");
                    window.location.href = `${API_BASE_URL}/masa/${masaId || orderDetail.masaId}`;
                }, 1500);

            } catch (err) {
                console.error("Nakit √∂deme hatasƒ±:", err);
                showTxResult(`‚ùå Hata: ${err.message}`, 'error');
                document.getElementById("btnCash").innerHTML = 'üíµ Nakit / Kasada √ñde';
                document.getElementById("btnCash").disabled = false;
            }
        }

        async function completePaymentOnBackend(txHash, odemeTuru = "Blockchain") {
            try {
                const endpoint = txHash ? '/api/order/completePayment' : '/api/order/finalizePayment';
                const body = txHash ? {
                    orderId: parseInt(orderId),
                    transactionHash: txHash,
                    amount: orderDetail.netTutar
                } : {
                    siparisId: parseInt(orderId),
                    satisKodu: orderDetail.satisKodu,
                    txHash: null,
                    odemeTuru: odemeTuru,
                    odenenTutar: orderDetail.netTutar
                };

                const res = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                
                if (!data.success) {
                    throw new Error(data.message || "√ñdeme kaydƒ± ba≈üarƒ±sƒ±z");
                }

                console.log('Backend √∂deme kaydƒ± ba≈üarƒ±lƒ±:', data);
                return data;

            } catch (err) {
                console.error("Backend √∂deme kaydƒ± hatasƒ±:", err);
                throw err;
            }
        }

        function showTxResult(message, type) {
            const txResult = document.getElementById("txResult");
            txResult.textContent = message;
            txResult.className = `tx-result show ${type}`;
        }
    </script>
</body>
</html>
